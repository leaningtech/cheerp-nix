version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@1

jobs:
  setup:
    docker:
      - image: nixos/nix:latest
    resource_class: large
    steps:
      - checkout
      - run:
          name: Configure Nix
          command: |
            cat \<< 'EOF' > /etc/nix/nix.conf
              experimental-features = nix-command flakes ca-derivations
              cores = 4
              max-jobs = 2
              sandbox = false
              sandbox-fallback = true
              system-features = nixos-test benchmark big-parallel kvm
              substituters = https://nix.leaningtech.com/cheerp https://cache.nixos.org/
              trusted-public-keys = cheerp:WtaH6hNyE1jx3KqrDkTqHfub4qEBhJWZwiIuPAPqF44= lt:990XBPGBQWHGyzpLno3a5vfWo5G8O+0qlxRmrvbOQVQ= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
              trusted-users = root circleci
            EOF
      - run:
          name: Install utilities
          command: |
            nix profile install nixpkgs#jq nixpkgs#attic-client
      - run:
          name: Setup attic
          command: |
            attic login lt https://nix.leaningtech.com ${ATTIC_TOKEN}
      - run:
          name: Evaluate Build
          command: |
            ./ci/generate-config.py > /tmp/config
            cat /tmp/config
            exit 1
      - run:
          name: Upload to cache
          command: |
            attic push lt:cheerp *.drv
      - continuation/continue:
          configuration_path: /tmp/config

workflows:
  setup-dynamic-config:
    when:
      equal: [ << pipeline.trigger_source >>, "api" ]
    jobs:
      - setup
